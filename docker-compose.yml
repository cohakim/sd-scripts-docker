version: '3'

x-gpu: &USE_GPU
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            device_ids: ['all']
            capabilities: [gpu]

services:
  train:
    <<: *USE_GPU
    build: .
    image: cohakim/sd-scripts:latest
    shm_size: '2gb'
    volumes:
      - huggingface_cache:/root/.cache/huggingface
      - ./config:/config
      - ./output:/output
      - ./training_data:/training_data
    environment:
      - DATASET
    entrypoint: |
      /bin/bash -c "
        poetry run accelerate launch \\
          --config_file accelerate.config \\
          --num_cpu_threads_per_process 1 \\
          train_network.py \\
          --config_file=/training_data/datasets/$${DATASET}/config.toml \\
          --dataset_config=/training_data/datasets/$${DATASET}/dataset.toml
      "

volumes:
  huggingface_cache:
